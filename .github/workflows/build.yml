name: Build and Test

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: macos-latest  # Using macOS runner for iOS/iPad development
    
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0  # For git-secrets scanning
    
    - name: Set up Xcode
      uses: maxim-lobanov/setup-xcode@v1
      with:
        xcode-version: 'latest-stable'
    
    - name: Install git-secrets
      run: |
        brew install git-secrets
        git secrets --install
        git secrets --register-aws
    
    - name: Security Scan
      run: git secrets --scan
    
    - name: Build App
      run: |
        xcodebuild clean build \
          -project AudioMaster.xcodeproj \
          -scheme AudioMaster \
          -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -quiet

    - name: Run Tests
      run: |
        xcodebuild test \
          -project AudioMaster.xcodeproj \
          -scheme AudioMaster \
          -destination 'platform=iOS Simulator,name=iPad Pro (12.9-inch) (6th generation)' \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          -quiet

    - name: Build Verification
      run: |
        echo "Project structure verification:"
        echo "Swift files found: $(find Sources -name "*.swift" | wc -l)"
        echo "Test files found: $(find Tests -name "*.swift" | wc -l)"
        echo "Build verification completed"
    
    - name: Generate Project Report
      run: |
        echo "AudioMaster Project Report" > project-report.txt
        echo "Generated: $(date)" >> project-report.txt
        echo "Swift files: $(find Sources -name "*.swift" | wc -l)" >> project-report.txt
        echo "Test files: $(find Tests -name "*.swift" | wc -l)" >> project-report.txt
        echo "Lines of code: $(find Sources -name "*.swift" -exec wc -l {} \; | awk '{sum+=$1} END {print sum}')" >> project-report.txt

    - name: Upload Project Report
      uses: actions/upload-artifact@v4
      with:
        name: project-report
        path: project-report.txt
        retention-days: 14
        overwrite: true
